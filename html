<!DOCTYPE html>
<html>
<head>
  <title>Boston Hospital Finder</title>
  <meta charset="UTF-8">

  <!-- TODO: Ticket 1 ‚Äî add Leaflet CSS link here -->

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: Arial, sans-serif; background: #f5f5f5; }

    #header {
      background: #003087; color: white;
      padding: 16px 24px;
    }
    #header h1 { font-size: 22px; }
    #header p  { font-size: 13px; opacity: 0.8; margin-top: 4px; }

    #controls {
      background: white; padding: 14px 24px;
      display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
      border-bottom: 1px solid #ddd;
    }
    input, select, button {
      padding: 8px 12px; font-size: 15px;
      border: 1px solid #ccc; border-radius: 4px;
    }
    button { background: #003087; color: white; border: none; cursor: pointer; }
    button:hover { background: #00205b; }

    #main { display: flex; height: calc(100vh - 110px); }

    /* TODO: Ticket 1 ‚Äî add #map style here */

    #sidebar {
      width: 100%; /* TODO: Ticket 1 ‚Äî change to 320px once map is added */
      background: white;
      border-left: 1px solid #ddd;
      display: flex; flex-direction: column;
      overflow: hidden;
    }
    #sidebar-header {
      padding: 12px 16px; background: #f9f9f9;
      border-bottom: 1px solid #ddd; font-size: 13px; color: #555;
    }
    #results { overflow-y: auto; flex: 1; padding: 10px; }
    #loading {
      display: none; padding: 20px;
      text-align: center; color: #555; font-size: 14px;
    }

    .hospital-card {
      border: 1px solid #ddd; border-radius: 6px;
      padding: 10px 12px; margin-bottom: 8px;
      cursor: pointer; transition: border-color 0.2s;
    }
    .hospital-card:hover { border-color: #003087; }
    .hospital-card.active { border-color: #003087; background: #f0f4ff; }
    .hospital-name { font-weight: bold; font-size: 14px; }
    .hospital-meta { font-size: 12px; color: #666; margin-top: 3px; }
    .dist-badge {
      display: inline-block; background: #003087; color: white;
      border-radius: 10px; padding: 1px 8px; font-size: 11px; margin-left: 6px;
    }

    /* TODO: Ticket 2 ‚Äî add popup styles here if needed */
  </style>
</head>
<body>

<div id="header">
  <h1>üè• Boston Hospital Finder</h1>
  <p>Find nearby hospitals and explore neighborhood vulnerability across Boston</p>
</div>

<div id="controls">
  <input type="text" id="zip" placeholder="Enter ZIP code (e.g. 02115)" maxlength="5" style="width:220px">
  <select id="radius">
    <option value="1">Within 1 mile</option>
    <option value="5" selected>Within 5 miles</option>
    <option value="10">Within 10 miles</option>
    <option value="25">Within 25 miles</option>
  </select>
  <button onclick="findHospitals()">Search</button>
</div>

<div id="main">

  <!-- TODO: Ticket 1 ‚Äî add <div id="map"></div> here -->

  <div id="sidebar">
    <div id="sidebar-header">Enter a ZIP code to find nearby hospitals</div>
    <div id="loading">‚è≥ Loading data...</div>
    <div id="results"></div>
  </div>
</div>

<!-- TODO: Ticket 1 ‚Äî add Leaflet JS script tag here -->

<script>
// ‚îÄ‚îÄ Data URLs ‚îÄ‚îÄ
const HOSPITAL_CSV = "https://data.boston.gov/dataset/d9871e89-2d1e-4ecf-b0de-046f553027c0/resource/6222085d-ee88-45c6-ae40-0c7464620d64/download/hospital-locations.csv";
const VULN_CSV     = "https://bostonopendata-boston.opendata.arcgis.com/api/download/v1/items/34f2c48b670d4b43a617b1540f20efe3/csv?layers=0";

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
// TODO: Ticket 1 ‚Äî add map and markersLayer variables here
let vulnByNeigh = {}; // stores vulnerability scores keyed by neighborhood name

// ‚îÄ‚îÄ TODO: Ticket 1 ‚Äî add initMap() function here ‚îÄ‚îÄ
// Should:
// 1. Create a Leaflet map centered on Boston [42.3601, -71.0589] zoom 12
// 2. Add OpenStreetMap tile layer
// 3. Create a markersLayer (L.layerGroup) and add to map

// ‚îÄ‚îÄ Robust CSV parser (handles quoted fields with embedded commas and newlines) ‚îÄ‚îÄ
function parseCSV(text) {
  const results = [];
  let i = 0, headers = null;
  function parseField() {
    if (text[i] === '"') {
      i++;
      let val = "";
      while (i < text.length) {
        if (text[i] === '"' && text[i+1] === '"') { val += '"'; i += 2; }
        else if (text[i] === '"') { i++; break; }
        else val += text[i++];
      }
      return val.trim();
    }
    let val = "";
    while (i < text.length && text[i] !== ',' && text[i] !== '\n' && text[i] !== '\r')
      val += text[i++];
    return val.trim();
  }
  function parseLine() {
    const fields = [];
    while (i < text.length && text[i] !== '\n' && text[i] !== '\r') {
      fields.push(parseField());
      if (text[i] === ',') i++;
    }
    if (text[i] === '\r') i++;
    if (text[i] === '\n') i++;
    return fields;
  }
  headers = parseLine().map(h => h.toUpperCase());
  while (i < text.length) {
    if (text[i] === '\r' || text[i] === '\n') { i++; continue; }
    const vals = parseLine();
    if (!vals.length || (vals.length === 1 && !vals[0])) continue;
    const obj = {};
    headers.forEach((h, idx) => obj[h] = vals[idx] || "");
    results.push(obj);
  }
  return results;
}

// ‚îÄ‚îÄ Euclidean distance in miles ‚îÄ‚îÄ
// 1 degree latitude ‚âà 69 miles, 1 degree longitude ‚âà 52 miles in Boston
// Simple and accurate enough for short local distances
function distMiles(lat1, lon1, lat2, lon2) {
  const dLat = (lat2 - lat1) * 69;
  const dLon = (lon2 - lon1) * 52;
  return Math.sqrt(dLat * dLat + dLon * dLon);
}

// ‚îÄ‚îÄ ZIP ‚Üí lat/lon using free Zippopotam API ‚îÄ‚îÄ
async function getZipCoords(zip) {
  const res = await fetch(`https://api.zippopotam.us/us/${zip}`);
  if (!res.ok) return null;
  const d = await res.json();
  return {
    lat: parseFloat(d.places[0].latitude),
    lon: parseFloat(d.places[0].longitude),
    city: d.places[0]["place name"],
    state: d.places[0]["state"]
  };
}

// ‚îÄ‚îÄ TODO: Ticket 1 ‚Äî add makeMarker(lat, lon) function here ‚îÄ‚îÄ
// Use L.circleMarker, radius 10, blue fill, white border

// ‚îÄ‚îÄ TODO: Ticket 2 ‚Äî add loadVulnerability() function here ‚îÄ‚îÄ
// Should:
// 1. Fetch VULN_CSV and parse it
// 2. Group rows by neighborhood Name (multiple census tracts per neighborhood)
// 3. For each neighborhood sum up the population and your chosen factors across all tracts
// 4. Calculate each chosen factor as a percentage of total population:
//    e.g. olderPct = (totalOlderAdult / totalPOP) * 100
// 5. Store your chosen percentages in vulnByNeigh keyed by uppercase neighborhood name
//
// Available columns to choose from (pick at least 2):
//   OlderAdult  ‚Äî residents over 65
//   TotChild    ‚Äî children under 5
//   Low_to_No   ‚Äî low or no income households
//   TotDis      ‚Äî people with disabilities
//   LEP         ‚Äî limited English proficiency
//
// Think about: which factors are most relevant to hospital access?

// ‚îÄ‚îÄ TODO: Ticket 2 ‚Äî add makePopupHTML(hospital, vuln) function here ‚îÄ‚îÄ
// Should show:
// - Hospital name and address
// - A breakdown table: % elderly, % children under 5,
//   % low income, % disabilities, % limited English

// ‚îÄ‚îÄ Render sidebar cards ‚îÄ‚îÄ
function renderSidebar(matches, markers) {
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";
  matches.forEach((h, idx) => {
    const card = document.createElement("div");
    card.className = "hospital-card";
    card.innerHTML = `
      <div class="hospital-name">
        ${h.NAME}
        <span class="dist-badge">${h.dist.toFixed(1)} mi</span>
      </div>
      <div class="hospital-meta">üìç ${h.AD || ""} &nbsp;|&nbsp; üèô ${h.NEIGH || ""}</div>
    `;
    card.onclick = () => {
      document.querySelectorAll(".hospital-card").forEach(c => c.classList.remove("active"));
      card.classList.add("active");
      // TODO: Ticket 1 ‚Äî pan map and open popup: markers[idx].openPopup(); map.panTo(...)
    };
    resultsDiv.appendChild(card);
  });
}

// ‚îÄ‚îÄ Main search function ‚îÄ‚îÄ
async function findHospitals() {
  const zipInput   = document.getElementById("zip").value.trim();
  const radius     = parseFloat(document.getElementById("radius").value);
  const resultsDiv = document.getElementById("results");
  const loading    = document.getElementById("loading");
  const sidebarHdr = document.getElementById("sidebar-header");

  if (!zipInput || zipInput.length < 5) {
    resultsDiv.innerHTML = "<p style='padding:16px;color:#666'>Please enter a valid 5-digit ZIP code.</p>";
    return;
  }

  loading.style.display = "block";
  resultsDiv.innerHTML  = "";
  // TODO: Ticket 1 ‚Äî clear existing markers: markersLayer.clearLayers()

  // Step 1: convert ZIP to coordinates
  const coords = await getZipCoords(zipInput);
  if (!coords) {
    loading.style.display = "none";
    resultsDiv.innerHTML = "<p style='padding:16px;color:red'>ZIP code not found.</p>";
    return;
  }

  // Step 2: fetch hospital CSV
  // TODO: Ticket 2 ‚Äî also load vulnerability data here using Promise.all
  const hospText  = await fetch(HOSPITAL_CSV).then(r => r.text());
  const hospitals = parseCSV(hospText);

  // Step 3: extract coordinates from Location field and filter by radius
  // Location field format: "(42.336, -71.107)"
  const coordRx = /\(\s*([-\d.]+),\s*([-\d.]+)\s*\)/;
  const matches = hospitals.map(h => {
    const m = (h["LOCATION"] || "").match(coordRx);
    if (!m) return null;
    const lat = parseFloat(m[1]), lon = parseFloat(m[2]);
    if (!lat || !lon) return null;
    return { ...h, lat, lon, dist: distMiles(coords.lat, coords.lon, lat, lon) };
  }).filter(h => h && h.dist <= radius).sort((a, b) => a.dist - b.dist);

  loading.style.display = "none";

  if (!matches.length) {
    sidebarHdr.textContent = `No hospitals within ${radius} miles of ${zipInput}`;
    resultsDiv.innerHTML = "<p style='padding:16px;color:#666'>Try increasing the search radius.</p>";
    return;
  }

  sidebarHdr.textContent = `${matches.length} hospital${matches.length > 1 ? "s" : ""} within ${radius} miles of ${coords.city}, ${coords.state}`;

  // Step 4: add markers to map
  // TODO: Ticket 1 ‚Äî loop matches, call makeMarker() and add each to markersLayer
  // TODO: Ticket 1 ‚Äî fit map to markers: map.fitBounds(L.featureGroup(markers).getBounds().pad(0.2))
  // TODO: Ticket 2 ‚Äî bind popup to each marker: marker.bindPopup(makePopupHTML(h, vuln))
  const markers = []; // TODO: Ticket 1 ‚Äî fill this array with your markers

  // Step 5: render sidebar
  renderSidebar(matches, markers);
}

// ‚îÄ‚îÄ Enter key support ‚îÄ‚îÄ
document.getElementById("zip").addEventListener("keydown", e => {
  if (e.key === "Enter") findHospitals();
});

// ‚îÄ‚îÄ Boot ‚îÄ‚îÄ
// TODO: Ticket 1 ‚Äî call initMap() here
</script>
</body>
</html>
